/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/@uwdata/mosaic-core@0.11.0/src/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{tableFromIPC as e}from"../flechette@1.1.0/_esm.js";import{agg as t,sql as n,create as r,asColumn as s,isBetween as i,and as c,scaleTransform as u,Query as o,Ref as a,isDescribeQuery as l,asRelation as h,count as f,max as d,min as p,isNull as m,or as y,isNotDistinct as g,literal as v,contains as _,prefix as b,suffix as $,regexp_matches as q}from"../mosaic-sql@0.11.0/_esm.js";import*as w from"../../@duckdb/duckdb-wasm@1.28.0/_esm.js";const E={};function S(e,t=!1){let n,r,s=E;function i(t){n=e(t).finally((()=>{if(r){const{value:e}=r;r=null,i(e)}else n=null}))}function c(e){n?function(e){r={event:e}}(e):i(e)}return t?function(e){s!==e&&requestAnimationFrame((()=>{const e=s;s=E,c(e)})),s=e}:c}class x{constructor(e){this._filterBy=e,this._requestUpdate=S((()=>this.requestQuery()),!0),this._coordinator=null}get coordinator(){return this._coordinator}set coordinator(e){this._coordinator=e}get filterBy(){return this._filterBy}get filterIndexable(){return!0}fields(){return null}fieldInfo(e){return this}query(e){return null}queryPending(){return this}queryResult(e){return this}queryError(e){return this}requestQuery(e){const t=e||this.query(this.filterBy?.predicate(this));return this._coordinator.requestQuery(this,t)}requestUpdate(){this._requestUpdate()}initialize(){return this._coordinator.initializeClient(this)}update(){return this}}function A(t){return e(t,{useDate:!0})}function R(e="ws://localhost:3000/"){const t=[];let n,r=!1,s=null;const i={open(){r=!0,u()},close(){for(r=!1,s=null,n=null;t.length;)t.shift().reject("Socket closed")},error(e){if(s){const{reject:t}=s;s=null,u(),t(e)}else console.error("WebSocket error: ",e)},message({data:e}){if(s){const{query:t,resolve:n,reject:r}=s;if(s=null,u(),"string"==typeof e){const t=JSON.parse(e);t.error?r(t.error):n(t)}else if("exec"===t.type)n();else{if("arrow"!==t.type)throw new Error(`Unexpected socket data: ${e}`);n(A(e))}}else console.log("WebSocket message: ",e)}};function c(c,o,a){null==n&&function(){n=new WebSocket(e),n.binaryType="arraybuffer";for(const e in i)n.addEventListener(e,i[e])}(),t.push({query:c,resolve:o,reject:a}),r&&!s&&u()}function u(){t.length&&(s=t.shift(),n.send(JSON.stringify(s.query)))}return{get connected(){return r},query:e=>new Promise(((t,n)=>c(e,t,n)))}}function T(e,...t){return`__${e}${t.length?"_"+t.map(k).join("_"):""}__`}function k(e){return`${e}`.replaceAll('"',"").replaceAll(" ","_")}function M(e,t){const n=e.subqueries;if(e.select&&0===n.length)return t(e);const r=M(n[0],t);for(let e=1;e<n.length;++e){const s=M(n[e],t);if(void 0!==s&&s!==r)return NaN}return r}function I(e,n){const r=T("count",n);return e[r]=t`COUNT(${n})`,t`SUM(${r})`.annotate({name:r})}function C(e,n,r){const s=I(e,r);return t`(SUM("${n}" * ${s.name}) / ${s})`}function O(e,n,[,r]){const s=T("max",r);return e[s]=t`MAX(${r})`,t`ARG_MAX("${n}", ${s})`}function L(e,n,[,r]){const s=T("min",r);return e[s]=t`MIN(${r})`,t`ARG_MIN("${n}", ${s})`}function U(e,r,s,i=!0){const c=I(e,r),u=T("rssq",r),o=T("rsum",r),a=n`${r} - ${s(r)}`;e[u]=t`SUM((${a}) ** 2)`,e[o]=t`SUM(${a})`;return t`(SUM(${u}) - (SUM(${o}) ** 2 / ${c})) / (${c}${i?" - 1":""})`}function N(e,n,r,s=!0){const i=P(e,n),c=j(e,n,r),u=B(e,1,n,r),o=B(e,0,n,r);return t`(${c} - ${u} * ${o} / ${i})${null===s?"":s?` / (${i} - 1)`:` / ${i}`}`}function G(e,n,r){const s=P(e,n),i=j(e,n,r),c=D(e,1,n,r),u=D(e,0,n,r),o=B(e,1,n,r),a=B(e,0,n,r),l=t`(${c} - (${o} ** 2) / ${s})`,h=t`(${u} - (${a} ** 2) / ${s})`;return t`(${i} - ${o} * ${a} / ${s}) / SQRT(${l} * ${h})`}function P(e,[n,r]){const s=T("count",n,r);return e[s]=t`REGR_COUNT(${n}, ${r})`,t`SUM(${s})`.annotate({name:s})}function B(e,n,r,s){const i=r[n],c=r[1-n],u=T("rs",i);return e[u]=t`SUM(${i} - ${s(i)}) FILTER (${c} IS NOT NULL)`,t`SUM(${u})`}function D(e,n,r,s){const i=r[n],c=r[1-n],u=T("rss",i);return e[u]=t`SUM((${i} - ${s(i)}) ** 2) FILTER (${c} IS NOT NULL)`,t`SUM(${u})`}function j(e,n,r){const[s,i]=n,c=T("sxy",s,i);return e[c]=t`SUM((${i} - ${r(i)}) * (${s} - ${r(s)}))`,t`SUM(${c})`}function Q(e,n){const[r,s]=n,i=P(e,n),c=T("avg",s,r);return e[c]=t`REGR_AVGX(${r}, ${s})`,t`(SUM(${c} * ${i.name}) / ${i})`}function F(e,n){const[r,s]=n,i=P(e,n),c=T("avg",r,s);return e[c]=t`REGR_AVGY(${r}, ${s})`,t`(SUM(${c} * ${i.name}) / ${i})`}function V(e,n,r,s){const i=P(e,r),c=B(e,n,r,s),u=D(e,n,r,s);return t`(${u} - (${c} ** 2 / ${i}))`}function z(e,n,r){const s=N(e,n,r,null),i=V(e,1,n,r);return t`(${s}) / ${i}`}function X(e,n,r){const s=Q(e,n),i=F(e,n),c=z(e,n,r);return t`${i} - (${c}) * ${s}`}function W(e){return e+(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24)}const Y={skip:!0,result:null};class H{constructor(e,{schema:t="mosaic",enabled:n=!0}={}){this.indexes=new Map,this.active=null,this.mc=e,this._schema=t,this._enabled=n}set enabled(e){this._enabled!==e&&(e||this.clear(),this._enabled=e)}get enabled(){return this._enabled}set schema(e){this._schema!==e&&(this.clear(),this._schema=e)}get schema(){return this._schema}dropIndexTables(){return this.clear(),this.mc.exec(`DROP SCHEMA IF EXISTS "${this.schema}" CASCADE`)}clear(){this.indexes.clear(),this.active=null}index(e,a,l){if(!this.enabled)return null;const{indexes:h,mc:f,schema:d}=this,{source:p}=l;if(!p)return null;if(this.active&&(this.active.source!==p&&this.clear(),null===this.active?.source))return null;let{active:m}=this;if(!m&&(this.active=m=function(e){const{source:t,meta:r}=e,o=e.predicate,a=o?.columns;let l,h;if(!r||!a)return{source:null,columns:h,predicate:l};const{type:f,scales:d,bin:p,pixelSize:m=1}=r;if("point"===f)l=e=>e,h=Object.fromEntries(a.map((e=>[`${e}`,s(e)])));else if("interval"===f&&d){const e=d.map((e=>function(e,t,r){const{type:s,domain:i,range:c,apply:o,sqlApply:a}=u(e);if(!o)return;const l=J[`${r}`.toLowerCase()]||"FLOOR",h=o(Math.min(...i)),f=o(Math.max(...i)),d="identity"===s?1:Math.abs(c[1]-c[0])/(f-h),p=d/t==1?"":d/t+"::DOUBLE * ",m=0===h?"":` - ${h}::DOUBLE`;return e=>n`${l}(${p}(${a(e)}${m}))::INTEGER`}(e,m,p)));e.some((e=>!e))||(1===e.length?(l=t=>t?i("active0",t.range.map(e[0])):[],h={active0:e[0](o.field)}):(l=t=>t?c(t.children.map((({range:t},n)=>i(`active${n}`,t.map(e[n]))))):[],h=Object.fromEntries(o.children.map(((t,n)=>[`active${n}`,e[n](t.field)])))))}return{source:h?t:null,columns:h,predicate:l}}(l),null===m.source))return null;if(h.has(e))return h.get(e);const y=function(e){if(!e.filterIndexable)return null;const n=e.query(),r=M(n,(e=>e.from()?.[0].from.table));if("string"!=typeof r||!n.select)return null;const s=[],i=[],c={},u=e=>{const t=e.column,s=M(n,(e=>e.select().find((e=>e.as===t))?.expr));return`(SELECT AVG(${s??e}) FROM "${r}")`};for(const e of n.select()){const{as:n,expr:{aggregate:r,args:o}}=e,a=r?.toUpperCase?.();switch(a){case"COUNT":case"SUM":s.push({[n]:t`SUM("${n}")::DOUBLE`});break;case"AVG":s.push({[n]:C(c,n,o[0])});break;case"ARG_MAX":s.push({[n]:O(c,n,o)});break;case"ARG_MIN":s.push({[n]:L(c,n,o)});break;case"VARIANCE":case"VAR_SAMP":c[n]=null,s.push({[n]:U(c,o[0],u)});break;case"VAR_POP":c[n]=null,s.push({[n]:U(c,o[0],u,!1)});break;case"STDDEV":case"STDDEV_SAMP":c[n]=null,s.push({[n]:t`SQRT(${U(c,o[0],u)})`});break;case"STDDEV_POP":c[n]=null,s.push({[n]:t`SQRT(${U(c,o[0],u,!1)})`});break;case"COVAR_SAMP":c[n]=null,s.push({[n]:N(c,o,u)});break;case"COVAR_POP":c[n]=null,s.push({[n]:N(c,o,u,!1)});break;case"CORR":c[n]=null,s.push({[n]:G(c,o,u)});break;case"REGR_COUNT":c[n]=null,s.push({[n]:t`${P(c,o)}::DOUBLE`});break;case"REGR_AVGX":c[n]=null,s.push({[n]:Q(c,o)});break;case"REGR_AVGY":c[n]=null,s.push({[n]:F(c,o)});break;case"REGR_SYY":c[n]=null,s.push({[n]:V(c,0,o,u)});break;case"REGR_SXX":c[n]=null,s.push({[n]:V(c,1,o,u)});break;case"REGR_SXY":c[n]=null,s.push({[n]:N(c,o,u,null)});break;case"REGR_SLOPE":c[n]=null,s.push({[n]:z(c,o,u)});break;case"REGR_INTERCEPT":c[n]=null,s.push({[n]:X(c,o,u)});break;case"REGR_R2":c[n]=null,s.push({[n]:t`(${G(c,o,u)}) ** 2`});break;case"MAX":case"MIN":case"BIT_AND":case"BIT_OR":case"BIT_XOR":case"BOOL_AND":case"BOOL_OR":case"PRODUCT":s.push({[n]:t`${a}("${n}")`});break;default:if(r)return null;i.push(n)}}return s.length?{from:r,dims:i,aggr:s,aux:c}:null}(e);let g;if(y)if(a.skip(e,l))g=Y;else{const t=a.remove(p).predicate(e);g=function(e,t,n,r){const{dims:s,aggr:i,aux:c}=n,{columns:u}=t,a=e.select({...u,...c}).groupby(Object.keys(u)),[l]=a.subqueries;if(l){!function(e,t){const n=new Set,r=e=>{n.has(e)||(n.add(e),e.select&&e.from().length&&e.select(t),e.subqueries.forEach(r))};r(e)}(l,Object.values(u).flatMap((e=>e.columns)))}const h=a.orderby();a.query.orderby=[];const f=a.toString(),d=(function(e){let t=2166136261;for(let n=0,r=e.length;n<r;++n){const r=e.charCodeAt(n),s=65280&r;s&&(t=W(t^s>>8)),t=W(t^255&r)}return function(e){return e+=e<<13,e^=e>>>7,e+=e<<3,e^=e>>>17,4294967295&(e+=e<<5)}(t)}(f)>>>0).toString(16),p=`${r}.cube_${d}`,m=o.select(s,i).from(p).groupby(s).orderby(h);return new Z({id:d,table:p,create:f,active:t,select:m})}(e.query(t),m,y,d),g.result=f.exec([`CREATE SCHEMA IF NOT EXISTS ${d}`,r(g.table,g.create,{temp:!1})]),g.result.catch((e=>f.logger().error(e)))}else g=null;return h.set(e,g),g}}const J={ceil:"CEIL",round:"ROUND"};class Z{constructor({table:e,create:t,active:n,select:r}={}){this.table=e,this.create=t,this.result=null,this.active=n,this.select=r,this.skip=!1}query(e){return this.select.clone().where(this.active.predicate(e))}}class K extends Promise{constructor(){let e,t;super(((n,r)=>{e=n,t=r})),this._resolve=e,this._reject=t}fulfill(e){return this._resolve(e),this}reject(e){return this._reject(e),this}}function ee(e,t,n){let r=[],s=0;function i(){const i=function(e,t){const n=[],r=new Map;for(const s of e){const{entry:{request:e}}=s,i=te(e.query,t);if(!r.has(i)){const e=[];n.push(e),r.set(i,e)}r.get(i).push(s)}return n}(r,t);r=[],s=0;for(const r of i)ne(r,e,n),se(r,t)}return{add(t,n){"arrow"===t.request.type?(s=s||("undefined"!=typeof requestAnimationFrame?requestAnimationFrame:"undefined"!=typeof setImmediate?setImmediate:setTimeout)((()=>i())),r.push({entry:t,priority:n,index:r.length})):e(t,n)}}}function te(e,t){const n=`${e}`;if(e instanceof o&&!t.get(n)){if(e.orderby().length||e.where().length||e.qualify().length||e.having().length)return n;const t=e.clone().$select("*"),r=e.groupby();if(r.length){const n={};e.select().forEach((({as:e,expr:t})=>n[e]=t)),t.$groupby(r.map((e=>e instanceof a&&n[e.column]||e)))}else e.select().some((({expr:e})=>e.aggregate))&&t.$groupby("ALL");return`${t}`}return n}function ne(e,t,n){if(function(e){if(e.length>1){const t=`${e[0].entry.request.query}`;for(let n=1;n<e.length;++n)if(t!==`${e[n].entry.request.query}`)return!0}return!1}(e))t({request:{type:"arrow",cache:!1,record:!1,query:e.query=re(e,n)},result:e.result=new K});else for(const{entry:n,priority:r}of e)t(n,r)}function re(e,t){const n=e.maps=[],r=new Map;for(const s of e){const{query:e}=s.entry.request,i=[];n.push(i);for(const{as:t,expr:n}of e.select()){const e=`${n}`;r.has(e)||r.set(e,[`col${r.size}`,n]);const[s]=r.get(e);i.push([s,t])}t(`${e}`)}const s=e[0].entry.request.query.clone(),i=s.groupby();if(i.length){const t={};e.maps[0].forEach((([e,n])=>t[n]=e)),s.$groupby(i.map((e=>e instanceof a&&t[e.column]||e)))}return s.$select(Array.from(r.values()))}async function se(e,t){const{maps:n,query:r,result:s}=e;if(!n)return;let i;try{i=await s}catch(t){for(const{entry:n}of e)n.result.reject(t);return}const c=l(r);e.forEach((({entry:e},r)=>{const{request:s,result:u}=e,o=n[r],a=c&&o?function(e,t){const n=new Map(t),r=[];for(const t of e)n.has(t.column_name)&&r.push({...t,column_name:n.get(t.column_name)});return r}(i,o):o?function(e,t){return e.select(t.map((e=>e[0])),t.map((e=>e[1])))}(i,o):i;s.cache&&t.set(String(s.query),a),u.fulfill(a)}))}K.prototype.constructor=Promise;const ie="undefined"!=typeof requestIdleCallback?requestIdleCallback:setTimeout;class ce{constructor(e){this.queue=Array.from({length:e},(()=>({head:null,tail:null})))}isEmpty(){return this.queue.every((e=>!e.head))}insert(e,t){const n=this.queue[t];if(!n)throw new Error(`Invalid queue priority rank: ${t}`);const r={item:e,next:null};null===n.head?n.head=n.tail=r:n.tail=n.tail.next=r}remove(e){for(const t of this.queue){let{head:n,tail:r}=t;for(let t=null,s=n;s;t=s,s=s.next)e(s.item)&&(s===n?n=s.next:t.next=s.next,s===r&&(r=t||n));t.head=n,t.tail=r}}next(){for(const e of this.queue){const{head:t}=e;if(null!==t)return e.head=t.next,e.tail===t&&(e.tail=null),t.item}}}const ue={High:0,Normal:1,Low:2};class oe{constructor(){this.queue=new ce(3),this.db=null,this.clientCache=null,this._logger=null,this._logQueries=!1,this.recorders=[],this.pending=null,this._consolidate=null}next(){if(this.pending||this.queue.isEmpty())return;const{request:e,result:t}=this.queue.next();this.pending=this.submit(e,t),this.pending.finally((()=>{this.pending=null,this.next()}))}enqueue(e,t=ue.Normal){this.queue.insert(e,t),this.next()}recordQuery(e){this.recorders.length&&e&&this.recorders.forEach((t=>t.add(e)))}async submit(e,t){try{const{query:n,type:r,cache:s=!1,record:i=!0,options:c}=e,u=n?`${n}`:null;if(i&&this.recordQuery(u),s){const e=this.clientCache.get(u);if(e)return this._logger.debug("Cache"),void t.fulfill(e)}const o=performance.now();this._logQueries&&this._logger.debug("Query",{type:r,sql:u,...c});const a=await this.db.query({type:r,sql:u,...c});s&&this.clientCache.set(u,a),this._logger.debug(`Request: ${(performance.now()-o).toFixed(1)}`),t.fulfill(a)}catch(e){t.reject(e)}}cache(e){return void 0!==e?this.clientCache=!0===e?function({max:e=1e3,ttl:t=108e5}={}){let n=new Map;function r(){const e=performance.now()-t;let r=null,s=1/0;for(const[t,i]of n){const{last:c}=i;c<s&&(r=t,s=c),e>c&&n.delete(t)}r&&n.delete(r)}return{get(e){const t=n.get(e);if(t)return t.last=performance.now(),t.value},set:(t,s)=>(n.set(t,{last:performance.now(),value:s}),n.size>e&&ie(r),s),clear(){n=new Map}}}():e||{get:()=>{},set:(e,t)=>t,clear:()=>{}}:this.clientCache}logger(e){return e?this._logger=e:this._logger}logQueries(e){return void 0!==e?this._logQueries=!!e:this._logQueries}connector(e){return e?this.db=e:this.db}consolidate(e){e&&!this._consolidate?this._consolidate=ee(this.enqueue.bind(this),this.clientCache,this.recordQuery.bind(this)):!e&&this._consolidate&&(this._consolidate=null)}request(e,t=ue.Normal){const n=new K,r={request:e,result:n};return this._consolidate?this._consolidate.add(r,t):this.enqueue(r,t),n}cancel(e){const t=new Set(e);t.size&&this.queue.remove((({result:e})=>!!t.has(e)&&(e.reject("Canceled"),!0)))}clear(){this.queue.remove((({result:e})=>(e.reject("Cleared"),!0)))}record(){let e=[];const t={add(t){e.push(t)},reset(){e=[]},snapshot:()=>e.slice(),stop(){return this.recorders=this.recorders.filter((e=>e!==t)),e}};return this.recorders.push(t),t}}function ae(e){switch(e){case"BIGINT":case"HUGEINT":case"INTEGER":case"SMALLINT":case"TINYINT":case"UBIGINT":case"UINTEGER":case"USMALLINT":case"UTINYINT":case"DOUBLE":case"FLOAT":case"REAL":return"number";case"DATE":case"TIMESTAMP":case"TIMESTAMPTZ":case"TIMESTAMP WITH TIME ZONE":case"TIME":case"TIMESTAMP_NS":return"date";case"BOOLEAN":return"boolean";case"VARCHAR":case"UUID":case"JSON":return"string";case"ARRAY":case"LIST":return"array";case"BLOB":case"STRUCT":case"MAP":case"GEOMETRY":return"object";default:if(e.startsWith("DECIMAL"))return"number";if(e.startsWith("STRUCT")||e.startsWith("MAP"))return"object";if(e.endsWith("]"))return"array";throw new Error(`Unsupported type: ${e}`)}}const le={count:f,distinct:e=>f(e).distinct(),max:d,min:p,nulls:e=>f().where(m(e))};async function he(e,t){return 1===t.length&&"*"==`${t[0].column}`?async function(e,t){const n=await e.query(`DESCRIBE ${h(t)}`);return Array.from(n).map((e=>({table:t,column:e.column_name,sqlType:e.column_type,type:ae(e.column_type),nullable:"YES"===e.null})))}(e,t[0].table):(await Promise.all(t.map((t=>async function(e,{table:t,column:r,stats:s}){const i=o.from({source:t}).select({column:r}).groupby(r.aggregate?n`ALL`:[]),[c]=Array.from(await e.query(o.describe(i))),u={table:t,column:`${r}`,sqlType:c.column_type,type:ae(c.column_type),nullable:"YES"===c.null};if(!s?.length&&!s?.size)return u;const[a]=await e.query(function(e,t,n){return o.from(e).select(Array.from(n,(e=>[e,le[e](t)])))}(t,r,s),{persist:!0});return Object.assign(u,a)}(e,t))))).filter((e=>e))}let fe;function de(e){return e?fe=e:null==fe&&(fe=new pe),fe}class pe{constructor(e=R(),{logger:t=console,manager:n=new oe,cache:r=!0,consolidate:s=!0,indexes:i={}}={}){this.manager=n,this.manager.cache(r),this.manager.consolidate(s),this.databaseConnector(e),this.logger(t),this.clear(),this.dataCubeIndexer=new H(this,i)}clear({clients:e=!0,cache:t=!0}={}){this.manager.clear(),e&&(this.filterGroups?.forEach((e=>e.disconnect())),this.filterGroups=new Map,this.clients?.forEach((e=>this.disconnect(e))),this.clients=new Set),t&&this.manager.cache().clear()}databaseConnector(e){return this.manager.connector(e)}logger(e){return arguments.length&&(this._logger=e||{debug(){},info(){},log(){},warn(){},error(){}},this.manager.logger(this._logger)),this._logger}cancel(e){this.manager.cancel(e)}exec(e,{priority:t=ue.Normal}={}){return e=Array.isArray(e)?e.filter((e=>e)).join(";\n"):e,this.manager.request({type:"exec",query:e},t)}query(e,{type:t="arrow",cache:n=!0,priority:r=ue.Normal,...s}={}){return this.manager.request({type:t,query:e,cache:n,options:s},r)}prefetch(e,t={}){return this.query(e,{...t,cache:!0,priority:ue.Low})}createBundle(e,t,n=ue.Low){const r={name:e,queries:t.map((e=>"string"==typeof e?{sql:e}:e))};return this.manager.request({type:"create-bundle",options:r},n)}loadBundle(e,t=ue.High){const n={name:e};return this.manager.request({type:"load-bundle",options:n},t)}updateClient(e,t,n=ue.Normal){return e.queryPending(),this.query(t,{priority:n}).then((t=>e.queryResult(t).update()),(t=>{this._logger.error(t),e.queryError(t)})).catch((e=>this._logger.error(e)))}requestQuery(e,t){return this.dataCubeIndexer.clear(),t?this.updateClient(e,t):Promise.resolve(e.update())}async connect(e){const{clients:t}=this;if(t.has(e))throw new Error("Client already connected.");t.add(e),e.coordinator=this,this.initializeClient(e),function(e,t,n){if(!t)return;let r=e.filterGroups.get(t);if(!r){const n=n=>function(e,t,n){const{dataCubeIndexer:r,filterGroups:s}=e,{clients:i}=s.get(t);for(const e of i)r.index(e,t,n)}(e,t,n),s=()=>function(e,t){const{dataCubeIndexer:n,filterGroups:r}=e,{clients:s}=r.get(t),{active:i}=t;return Promise.allSettled(Array.from(s,(r=>{const s=n.index(r,t,i),c=s?null:t.predicate(r);if(s?.skip||!s&&!c)return;const u=s?.query(i.predicate)??r.query(c);return e.updateClient(r,u)})))}(e,t);t.addEventListener("activate",n),t.addEventListener("value",s),r={selection:t,clients:new Set,disconnect(){t.removeEventListener("activate",n),t.removeEventListener("value",s)}},e.filterGroups.set(t,r)}r.clients.add(n)}(this,e.filterBy,e)}async initializeClient(e){const t=e.fields();return t?.length&&e.fieldInfo(await he(this,t)),e.requestQuery()}disconnect(e){const{clients:t,filterGroups:n}=this;if(!t.has(e))return;t.delete(e),e.coordinator=null;const r=n.get(e.filterBy);r&&r.clients.delete(e)}}class me{constructor(){this._callbacks=new Map}addEventListener(e,t){this._callbacks.has(e)||this._callbacks.set(e,{callbacks:new Set,pending:null,queue:new ye});this._callbacks.get(e).callbacks.add(t)}removeEventListener(e,t){const n=this._callbacks.get(e);n&&n.callbacks.delete(t)}willEmit(e,t){return t}emitQueueFilter(e,t){return null}cancel(e){const t=this._callbacks.get(e);t?.queue.clear()}async pending(e){await(this._callbacks.get(e)?.pending)}emit(e,t){const n=this._callbacks.get(e)||{};if(n.pending)n.queue.enqueue(t,this.emitQueueFilter(e,t));else{const r=this.willEmit(e,t),{callbacks:s,queue:i}=n;if(s?.size){const t=Array.from(s,(e=>e(r)));n.pending=Promise.allSettled(t).then((()=>{n.pending=null,i.isEmpty()||this.emit(e,i.dequeue())}))}}}}class ye{constructor(){this.clear()}clear(){this.next=null}isEmpty(){return!this.next}enqueue(e,t){const n={value:e};if(t&&this.next){let e=this;for(;e.next;)t(e.next.value)?e=e.next:e.next=e.next.next;e.next=n}else this.next=n}dequeue(){const{next:e}=this;return this.next=e?.next,e?.value}}function ge(e,t){return e!==t&&(e instanceof Date&&t instanceof Date?+e!=+t:!Array.isArray(e)||!Array.isArray(t)||function(e,t){if(e.length!==t.length)return!0;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!0;return!1}(e,t))}function ve(e){return e instanceof _e}class _e extends me{constructor(e){super(),this._value=e}static value(e){return new _e(e)}static array(e){if(e.some((e=>ve(e)))){const t=new _e,n=()=>{t.update(e.map((e=>ve(e)?e.value:e)))};return n(),e.forEach((e=>ve(e)?e.addEventListener("value",n):0)),t}return new _e(e)}get value(){return this._value}update(e,{force:t}={}){return ge(this._value,e)||t?this.emit("value",e):this.cancel("value"),this}willEmit(e,t){return"value"===e&&(this._value=t),t}}function be(e){return e instanceof qe}function $e(e,t){return new qe(new we(e),t?[t].flat():t)}class qe extends _e{static intersect({cross:e=!1,empty:t=!1,include:n=[]}={}){return $e({cross:e,empty:t},n)}static union({cross:e=!1,empty:t=!1,include:n=[]}={}){return $e({cross:e,empty:t,union:!0},n)}static single({cross:e=!1,empty:t=!1,include:n=[]}={}){return $e({cross:e,empty:t,single:!0},n)}static crossfilter({empty:e=!1,include:t=[]}={}){return $e({cross:!0,empty:e},t)}constructor(e=new we,t=[]){if(super([]),this._resolved=this._value,this._resolver=e,this._relay=new Set,Array.isArray(t))for(const e of t)e._relay.add(this)}clone(){const e=new qe(this._resolver);return e._value=e._resolved=this._value,e}remove(e){const t=this.clone();return t._value=t._resolved=t._resolver.resolve(this._resolved,{source:e}),t._value.active={source:e},t}get resolver(){return this._resolver}get single(){return this._resolver.single}get clauses(){return super.value}get active(){return this.clauses.active}get value(){return this.active?.value}valueFor(e){return this.clauses.find((t=>t.source===e))?.value}activate(e){this.emit("activate",e),this._relay.forEach((t=>t.activate(e)))}update(e){return this._resolved=this._resolver.resolve(this._resolved,e,!0),this._resolved.active=e,this._relay.forEach((t=>t.update(e))),super.update(this._resolved)}willEmit(e,t){return"value"===e?(this._value=t,this.value):t}emitQueueFilter(e,t){return"value"===e?this._resolver.queueFilter(t):null}skip(e,t){return this._resolver.skip(e,t)}predicate(e,t=!1){const{clauses:n}=this,r=t?null:n.active;return this._resolver.predicate(n,r,e)}}class we{constructor({union:e,cross:t,single:n,empty:r}={}){this.union=!!e,this.cross=!!t,this.single=!!n,this.empty=!!r}resolve(e,t,n=!1){const{source:r,predicate:s}=t,i=e.filter((e=>r!==e.source)),c=this.single?[]:i;return this.single&&n&&i.forEach((e=>e.source?.reset?.())),s&&c.push(t),c}skip(e,t){return this.cross&&t?.clients?.has(e)}predicate(e,t,n){const{empty:r,union:s}=this;if(r&&!e.length)return["FALSE"];if(this.skip(n,t))return;const i=e.filter((e=>!this.skip(n,e))).map((e=>e.predicate));return s&&i.length>1?y(i):i}queueFilter(e){if(this.cross){const t=e.active?.source;return e=>e.active?.source!==t}return null}}function Ee(e="http://localhost:3000/"){return{async query(t){const n=fetch(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"omit",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return"exec"===t.type?n:"arrow"===t.type?A(await(await n).arrayBuffer()):(await n).json()}}}function Se(e={}){const{duckdb:t,connection:n,...r}=e;let s,i=t,c=n;function u(){return s||(s=(i?Promise.resolve(i):xe(r).then((e=>i=e))).then((e=>e.connect())).then((e=>c=e))),s}async function o(){return c||await u(),c}return{getDuckDB:async function(){return i||await u(),i},getConnection:o,query:async e=>{const{type:t,sql:n}=e,r=await o(),s=await function(e,t){return new Promise(((n,r)=>{e.useUnsafe((async(e,s)=>{try{const r=await e.runQuery(s,t);n(r)}catch(e){r(e)}}))}))}(r,n);return"exec"===t?void 0:"arrow"===t?A(s):A(s).toArray()}}}async function xe({log:e=!1}={}){const t=w.getJsDelivrBundles(),n=await w.selectBundle(t),r=URL.createObjectURL(new Blob([`importScripts("${n.mainWorker}");`],{type:"text/javascript"})),s=new Worker(r),i=e?new w.ConsoleLogger:new w.VoidLogger,c=new w.AsyncDuckDB(i,s);return await c.instantiate(n.mainModule,n.pthreadWorker),URL.revokeObjectURL(r),c}function Ae(e,t,{source:n,clients:r=(n?new Set([n]):void 0)}){return{meta:{type:"point"},source:n,clients:r,value:t,predicate:void 0!==t?g(e,v(t)):null}}function Re(e,t,{source:n,clients:r=(n?new Set([n]):void 0)}){let s=null;if(t){const n=t.map((t=>{const n=t.map(((t,n)=>g(e[n],v(t))));return n.length>1?c(n):n[0]}));s=n.length>1?y(n):n[0]}return{meta:{type:"point"},source:n,clients:r,value:t,predicate:s}}function Te(e,t,{source:n,clients:r=(n?new Set([n]):void 0),bin:s,scale:c,pixelSize:u=1}){return{meta:{type:"interval",scales:c&&[c],bin:s,pixelSize:u},source:n,clients:r,value:t,predicate:null!=t?i(e,t):null}}function ke(e,t,{source:n,clients:r=(n?new Set([n]):void 0),bin:s,scales:u=[],pixelSize:o=1}){const a=null!=t?c(e.map(((e,n)=>i(e,t[n])))):null;return{meta:{type:"interval",scales:u,bin:s,pixelSize:o},source:n,clients:r,value:t,predicate:a}}const Me={contains:_,prefix:b,suffix:$,regexp:q};function Ie(e,t,{source:n,clients:r,method:s="contains"}){return{meta:{type:"match",method:s},source:n,clients:r,value:t,predicate:t?(0,Me[s])(e,v(t)):null}}function Ce(e){return"function"==typeof e?.getChild}function Oe(){const e=new Set;let t,n=new Promise((e=>t=e));return{pending(t){e.add(t)},ready:t=>(e.delete(t),0===e.size),resolve(){n=new Promise((e=>{t(),t=e}))},get promise(){return n}}}function Le(e){return Ce(e)?function(e){const{numRows:t}=e;return{numRows:t,columns:e.toColumns()}}(e):function(e){const t=e.length;if("object"==typeof e[0]){const n=t?Object.keys(e[0]):[],r={};return n.length>0&&n.forEach((t=>{r[t]=e.map((e=>e[t]))})),{numRows:t,columns:r}}return{numRows:t,values:e}}(e)}export{pe as Coordinator,x as MosaicClient,_e as Param,ue as Priority,qe as Selection,Te as clauseInterval,ke as clauseIntervals,Ie as clauseMatch,Ae as clausePoint,Re as clausePoints,de as coordinator,A as decodeIPC,ge as distinct,Ce as isArrowTable,ve as isParam,be as isSelection,Ee as restConnector,R as socketConnector,Oe as synchronizer,S as throttle,Le as toDataColumns,Se as wasmConnector};export default null;
